# Story 5,6

이전 프로토콜 스택의 송 수신 단계와 연결 종료 단계까지 알아보았다.

이제 실제 패킷이 구성되어 LAN 어뎁터를 통해 패킷이 송신 되는 과정을 알아보자

<br>

## Chapter 5 : IP와 이더넷의 패킷 송수신 동작

각 전체적 데이터 전송 과정에서의 패킷의 구성과 전송되어지는 순서에 초점을 맞추어 알아보자

<br>

<계층별 구성도>

<img width="405" alt="스크린샷 2022-03-11 오전 2 06 01" src="https://user-images.githubusercontent.com/81874493/157721203-7d2662f1-2193-425a-8acc-2b0752285710.png">

<br>

## 01) TCP 혹은 UDP 프로토콜 담당 부분에서 헤더와 데이터를 IP 프로토콜 담당 부분에게 넘긴다.

<img width="684" alt="스크린샷 2022-03-11 오전 2 06 07" src="https://user-images.githubusercontent.com/81874493/157721219-94ec5700-0517-4436-b0b0-fa0bc52b2efe.png">

<br>

## 02) IP 프로토콜 담당 부분은 받은 데이터에 IP 헤더와 MAC 헤더를 붙이게 된다.

<img width="671" alt="스크린샷 2022-03-11 오전 2 06 12" src="https://user-images.githubusercontent.com/81874493/157721239-89bbd235-c32f-4b79-9f75-258e7c321e3b.png">

- IP header
    - 송신처 IP : 송신할 주체의 LAN adapter에 기록된 IP를 기록
    - 수신처 IP : DNS 조회를 통해 얻은 송신할 대상의 IP 기록
    
- MAC header
    - 송신처 MAC : 송신할 주체의 LAN adapter에 할당된 고유 식별자인 MAC 주소 기록
        - MAC : 통신을 위한 네트워크 인터페이스(LAN adapter)에 할당된 고유 식별자
        
    - 수신처 MAC
        - 현재 TCP/UDP 의 데이터를 받아 패킷을 구성하는 시점에서 수신처의 MAC 주소를 알 수 없다.
            
            ⇒ 그렇기 때문에 수신측 IP에 해당되는 MAC 주소를 찾는 과정이 필요하다.
            
            - ARP를 통해 수신처의 MAC 주소를 찾아 기록한다.
                
                <img width="576" alt="스크린샷 2022-03-11 오전 2 06 18" src="https://user-images.githubusercontent.com/81874493/157721257-0b967fbe-dd14-4231-a4a5-59fc9857313e.png">

                1) Rounting Table 에 기록되어 있는 처음으로 패킷을 받는 라우터 에게 MAC주소 의뢰를 한다. 
                
                2) 라우터는 요청받은 IP가 누구인지 브로드케스트를 통해 물어본다
                
                3) IP에 해당하는 기기는 자신의 MAC 주소를 보내준다.
                
                4) 수신해야할 MAC주소를 확인한다.
                
                - 참고) ARP 캐시
                    
                    <details>
                        
                    <summary>ARP 캐시</summary>

                    매번 위의 과정처럼 브로드 캐스트를 통해 물어보게 되면 패킷의 양이 불어난다.
                    
                    - 해결방법 : 한번 조사한 내용을  ARP 캐시라는 메모리 영역에 보존하여 재활용한다.
                    
                    <br>

                    - 한번 조사한 내용을 ARP 캐시에 저장하고 이후 같은 IP 에 대한 MAC주소 조사에 사용한다.
                    - 단, MAC 주소를 한번 조사하고 계속 유지하여 사용하는것이 아니다.
                        - OS의  종류에 따라 보존하는 시간에 맞춰 삭제한다.
                                
                            >⇒ 이를 통해 IP-MAC의 불일치 될 수 있는 상황을 줄인다.
                            </details>
                        
            

<br>

## 03) IP프로토콜 담당에서 LAN Driver를 통해 패킷 송신을 의뢰한다.

<img width="497" alt="스크린샷 2022-03-11 오전 2 06 25" src="https://user-images.githubusercontent.com/81874493/157721276-b59e61b3-4072-4ece-a64c-64bd22d35eec.png">

- 구성을 완료한 패킷 전송을 요청하기 위해 LAN adapter에게 송신을 요청하여야 한다.
    
    ⇒ 하지만 LAN adapter는 단독으로 동작하지 않는다.
    
    - LAN adapter의 동작을 제어하기 위해서는 LAN Driver Software를 통해  제어하여
        
        ⇒ LAN adapter가 패킷을 전송할 수 있도록 한다.
        

<br>

## 04) LAN adapter 가 패킷을 송신한다.

<img width="653" alt="스크린샷 2022-03-11 오전 2 06 34" src="https://user-images.githubusercontent.com/81874493/157721302-498f4866-f645-4788-b396-53f9d3ac7c0b.png">

- 버퍼 메모리 : 송수신 하는 패킷을 일시적으로 저장하는 메모리 영역
    
    ⇒ 송, 수신에 대한 각각의 영역이 있다.
    
- MAC : 충돌, 검출 / 재송신 등 이더넷의 송 수신 동작을 제어하는 부분
    - ROM : MAC 주소를 기입하는 부분
- PHY(MAU) : 신호를 송신하는 회로와 신호를 수신하는 회로를 합친것
- RJ45 : LAN 케이블을 접속하는 커넥터

<br>

패킷 전송 과정)

1. LAN 드라이버는 패킷을 받으면 그것을 버퍼 메모리에 복사한다.
2. 복사를 마친 후 패킷을 송신하도록 MAC 회로에 명령을 보내어 MAC 회로 작업이 시작
3. MAC회로에서 제어용 데이터를 추가한다.
    
    <img width="682" alt="스크린샷 2022-03-11 오전 2 06 39" src="https://user-images.githubusercontent.com/81874493/157721322-b019123d-d451-4907-a51a-ece71d65199e.png">

    - 프리앰블과 스타트 프레임 딜리미터
        - 프리앰블 : 타이밍 맞춤
        - 스타트 프레임 딜리미터 (SFD) : 프레임의 개시 위치 발견
    - FCS(Frame Check Sequence) : 오류 검출용 데이터

<br>

4. 프리앰블 ,SFD, FCS를 부가한 패킷을 맨 앞부터 1비트씩 디지털 신호 → 전기신호로 변환 하여 PHY(MAU) 에게 보낸다.
    - 신호를 송신하는 동작의 구분
        - 반이중 모드 ( half - duplex)
            
            ⇒ 상대측으로 부터 데이터를 송신과 수신 한가지만 진행될 수 있는 방식
            
        - 전이중 모드 ( full - duplex)
            
            ⇒ 상대측으로 부터 데이터를 송신과 수신이 동시에 진행될 수 있는 방식
            
5. PHY(MAU) 회로는 이 신호를 케이블에 송출할 수 있는 형식으로 변환하여 송신한다.
6. 송신한 패킷은 중계장치들을 경유하여 수신측에게 도착한다.
    
    <img width="663" alt="스크린샷 2022-03-11 오전 2 06 43" src="https://user-images.githubusercontent.com/81874493/157721347-b050511a-349e-4c23-8b5a-d1c2477e4189.png">

    - 패킷의 수신측 IP와 Routing table을 통해 중계장치들을 경유하여 수신측에게 패킷이 도착하게 된다.
    

<br>

## 05) 패킷의 수신

<img width="406" alt="스크린샷 2022-03-11 오전 2 06 48" src="https://user-images.githubusercontent.com/81874493/157721370-91e3b5a6-5f82-4340-bd54-081b6cf192b7.png">

1. 수신측에서 패킷은 PHY(MAU)에서 디지털 데이터로 변환하여 버퍼 메모리에 저장한다.
    
    <img width="626" alt="스크린샷 2022-03-11 오전 2 06 52" src="https://user-images.githubusercontent.com/81874493/157721381-d9186fd6-4bb1-435c-947e-729e3f154c66.png">

    - 패킷의 맨 앞부터 계산을 적용하여 FCS의 값을 계산하고 패킷의 끝의 FCS값과 비교하여 오류 패킷을 검사한다.
    
    <br>

2. MAC헤더의 수신처 주소와 비교하여 자신에게 오는것인지 판단한다.
    - 자신에게 오는 패킷일 경우에만 버퍼 메모리에 저장한다.
    
    <br>

3. MAC 회로가 할일이 끝나면 패킷을 수신한 사실을 컴퓨터에게 통지한다.
    - 여기서의 통지는 인터럽트를 통해 통지되며 CPU는 LAN 드라이버를 통해 LAN 어뎁터를 제어하며 수신 동작을 실행한다.
    
    <br>

4. 패킷은 IP 담당부분으로 넘어가게 되고 IP헤더의 포멧에 문제가 없는지 확인하고 TCP 담당부분에게 패킷을 넘긴다.
    - 만약 IP헤더에서 수신처 IP와 자신의 IP가 다른것과 같은 오류가 있을 경우 ICMP라는 메시지를 통해 오류를 통지한다.
    
    <br>

5. TCP 부분으로 넘어온 패킷의 헤더를 분석하고 수신처 포트 번호를 조사하여 해당 소켓을 찾아낸다.

<br>

6. 해당 소켓의 상태 ( 접속단계, 송수신 단계, 종료단계) 에 맞는 동작을 실행한다.

<br>

* * *
<br>

## Story 06 : UDP 프로토콜을 이용한 송 수신 동작

### TCP가 아닌 UDP를 사용하는 경우는 언제일까??

1) 제어용 짧은 데이터

    DNS 조회 와 같이 제어용으로 실행하는 정보 교환은 한개의 패킷으로 끝나므로 UDP를 사용하는 것이 더 효율적이다.

2) 음성 및 동영상 데이터

    음성이나 영상의 데이터를 보낼때 TCP와 같이 오류 검출하여 다시 보내는 방법을 사용하면 재전송시에 시간이 걸리게 된다

    >⇒ 그 시간으로 인해 재생 타이밍이 맞지 않아 중간에 끊기는 음이나 영상을 되돌릴 수 없다.

    >⇒ 그렇기에 TCP 보다 UDP를 사용하는 측면이 더 효율적이다.

결론)

UDP 프로토콜을 사용하는 경우는

>⇒ TCP의 복잡한 구조를 통해 재전송 및 오류 검출등의 기능이 필요 없을 경우에 한에 UDP를 사용한다.
