# 프로토콜 스택 ┃ Part 1

- [프로토콜 스택 ┃ Part 1](#프로토콜-스택--part-1)
  - [들어가며](#들어가며)
  - [프로토콜 스택 내부 구조](#프로토콜-스택-내부-구조)
  - [Socket 라이브러리 호출에 따른 프로토콜 스택의 동작](#socket-라이브러리-호출에-따른-프로토콜-스택의-동작)
    - [소켓을 작성한다.](#소켓을-작성한다)
    - [서버에 접속한다.](#서버에-접속한다)

## 들어가며

이전 9주차에서 다음과 같이 글을 종단하였다.

<dl><dt>
14. 클라이언트측에서 소켓을 만드는데...
<br/>
15. 이후 클라이언트측 소켓에서 서버측의 소켓으로 파이프 연결을 시도한다.
</dt></dl>

이 부분을 10주차에서 자세히 다뤄보고자 한다.

## 프로토콜 스택 내부 구조

프로토콜 스택은 내부에 통신 동작을 제어하기 위한 정보를 기록하는 메모리 영역을 가진다.

프로토콜 스택은 이 제어 정보를 참조하며 동작한다.

제어 정보란

    1. 헤더에 기입되는 정보
    2. 소켓에 기록되는 정보

    cf. 통신 상대의 IP주소는 무엇인가
        통신 동작이 어떤 진행 상태에 있는가
          - 송신 동작 후의 경과 시간
          - 응답의 여부

헤더에 기입되는 정보는 

    이후 별도의 링크에서 확인가능하다.

소켓에 기록되는 정보는 다음과 같다.

```shell
프로토콜  로컬 주소              외부 주소              상태            PID
  TCP    0.0.0.0:65004          0.0.0.0:0              LISTENING       4604
  TCP    127.0.0.1:1030         127.0.0.1:1031         ESTABLISHED     6068
```

이전 9주차에서 소켓을 

    데이터 통로 간의 출입구라고 추상화해서 말했는데,

이번 주차를 통해 소켓을

    제어 정보를 기록한 메모리 영역

이라고 풀어 생각할 수 있다.

## Socket 라이브러리 호출에 따른 프로토콜 스택의 동작

이전 9주차에서 HTTP 메시지 송·수신 동작으로 다음과 같은 코드를 작성하였다.

```
browser{
    DNS 송·수신 동작

    Socket.socket();  
    Socket.connect(); 
    ...

}
```
각 메소드당 프로토콜 스택의 내부는 어떻게 동작하는지 알아보자.

### 소켓을 작성한다.

`Socket.socket()`은 소켓을 만드는 단계이다.

프로토콜 스택은 소켓 한 개 분량의 메모리 영역을 확보하고,

초기 상태임을 나타내는 제어 정보를 기록한다.

메모리 영역을 확보한다는 것은

    OS의 메모리 관리 모듈에 신청하여 메모리 영역을 할당받는 것을 말한다.

### 서버에 접속한다.

소켓을 만든 뒤, `Socket.connect()`는 서버측 소켓에 접속하는 단계이다.

케이블은 항상 연결되어 있기 때문에 제어 정보를 통해 

통신 상대와 데이터 송·수신이 가능한 상태를 만들어야한다.

이 상태를 만드는 과정을 TCP 3 Way-Handsake 라고 말한다.

각 Way 마다 클라이언트측이냐 서버측이냐 주체만 달라질 뿐 다음과 같은 세부과정이 있다.

1. TCP 에서 TCP 헤더를 만든다.
2. TCP 헤더에 `송신처 포트 번호`에서 `수신처 포트 번호`로 접속하는 소켓을 지정한다.
3. TCP 헤더를 만들면 IP에 건네주어 송신을 의뢰한다.
4. IP에서 패킷 송신 동작을 실행하고, 네트워크를 통해 수신처에 도착하면
5. 수신처 IP가 이것을 받고 TCP에 건네준다.
6. 수신처 TCP가 헤더를 조사하여 기록된 `수신처 포트 번호`에 해당하는 소켓을 찾아낸다.
7. 해당 소켓에 접속 동작 진행중이라는 상태로 갱신한다.
8. 서버측 TCP는 응답을 돌려준다.

전체적인 3 Way-Handsake를 [링크](https://slides.com/kimyongki/deck-6258c3/embed)로 확인해보자.

> 1. TCP 헤더의 시퀀스 번호를 포함한 내용은 다음 주차 내용이다.
> 2. 각 TCP 헤더의 색깔이 변한 것은 새로 만들었음을 의미한다.
> 3. 해당 링크의 슬라이드는 챕터2를 진행하는 동안 고도화될 예정이다.