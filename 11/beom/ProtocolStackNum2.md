# 프로토콜 스택


## 들어가며
![소켓 동작과정](asset/socket.PNG)

전 장에서 connent를 통해 server와 client를 소켓으로 연결하는 것을 배웠다.

이번 장에서는 write부터 공부하도록 하겠다.

## 데이터를 송, 수신한다.
### 프로토콜 스택에 HTTP 리퀘스트 메시지를 넘긴다.

애플리케이션 -> 프로토콜 스택에 Write() 명령을 통해 전송한다.

**< Write()의 상태 특징 >**

1. 프로토콜 스택은 단지 버퍼 메모리에 저장하기 위해 데이터의 크기는 알지만 세부내용은 알지 못한다.
2. 애플리케션의 종류나 만드는 방법에 따라 분할해서 전송 / 한 번에 전송 크게 2가지 방식으로 나눈다.(프로토콜 스택에서 제어 x)
   - 데이터를 곧바로 보낸다면 작은 패킷을 많이 보내는 경우가 생김(효율↓). 그렇기에 어느 정도 데이터를 저장하고 나서 송, 수신 동작을 한다.

**< 어느 정도까지 저장하고 송신할 지 판단하는 두 가지 요소 >**

1. 한 패킷에 저장할 수 있는 데이터의 크기(MTU)
   - 프로토콜 스택은 MTU라는 매개변수를 바탕으로 판단한다.
   - MTU는 한 패킷이 운반할 수 있는 데이터의 최대 길이
   - 이더넷에서 보통 1,500Byte
   - MTU는 데이터 + 헤더의 범위이고 순수데이터만 포함하는 명칭은 **MSS**
   - 애플리케이션에서 받은 데이터가 MSS를 초과하거나 MSS에 가까운 길이에 이르기까지 데이터를 저장하고 송신한다.
p.121  사진

2. 타이밍
   - 프로토콜 스택은 내부에 타이머가 있어서 일정 시간이 경과하면 MTU 여부에 상관없이 패킷을 전송

|  | MTU | 타이밍  |
|------|-------|---|
| 네트워크 이용 효율 | ▲ | ▼ |
| 버퍼 머문 시간 | 길다 | 짧다 |

결론 : MTU와 타이밍을 절충하여 송신 동작을 실행해야 한다.

그러나 TCP프로토콜에는 절충하는 규정이 없고 프로토콜 스택 개발자의 의해 절충된다. = OS 종류나 버전에 따라 절충

애플케이션 측에서도 송신의 타이밍을 제어 가능(옵션 지정)
- 브라우저와 같은 대화형 어플케이션의 경우는 버퍼에 머무는 만큼 응답 시간이 지연되기 때문에 옵션을 사용하여 바로 보내도록 할 수 있다.

### 데이터가 클 때는 분할 하여 보낸다.
- 폼을 사용한 긴 데이터 등 한 개의 패킷에 들어가지 않는 데이터가 있다.
  - 블로그, 게시판 등에서 긴 문장

1. 송신 버퍼에 저장된 데이터가 MSS의 길이를 초과한 경우
2. 다음 데이터를 기다리지 않고
3. 송신 버퍼에 들어있는 데이터를 맨 앞부터 차례대로 MSS의 크기에 맞게 분할
4. 분할한 조각을 한 개씩 패킷에 넣어 전송

p.123 사진

### ACK 번호를 사용하여 패킷이 도착했는지 확인한다.
TCP에는 송신한 패킷이 상대에게 올바르게 도착했는지 확인하고, 도착하지 않았다면 다시 송신하는 기능이 있으므로 송신한 후 확인 동작으로 넘어간다.

1. 데이터를 조각으로 분할할 때 조각이 통신 개시부터 따져서 몇 번째 바이트에 해당하는지 세어둔다.
2. 데이터의 조각을 송신할 때 세어둔 값을 TCP헤더에 기록한다.
  - **시퀀스 번호**라는 항목에 해당한다.
  - 송산하는 데이터의 크기도 전송하는데 이는 `패킷의 전체길이 - 헤더 길이` 이므로 헤더에 따로 작성하진 x
3. 누락이 없는 것을 확인하면 수식측은 그 이전에 수신한 데이터와 합쳐서 데이터를 몇 번째 바이트까지 수신한 것인지 계산하고, 그 값을 TCP 헤더의 ACK 번호에 기록하여 송신 측에 알려준다. 이렇게 ACK 번호를 되돌려주는 동작을 **수신 확인 응답**이라고한다.
   - 송신측은 이것을 통해 상대가 어디까지 수신했는지 파악
4. 실제로 시퀀스 번호는 1부터 시작하지 않고 난수를 바탕으로 산출한 초기값으로 시작한다. 데이터의 송, 수신을 시작하기 전에 초기값을 상대에게 알리게 되어 있다.
   - 악의적인 공격을 피하기 위함
5. TCP는 상대가 데이터를 받았는 지 확인할 때까지 송신한 패킷을 수신용 버퍼 메모리에 보관
   - ACK이 돌아오지 않았을 경우 재전송을 위함
   - 



p. 125 사진



