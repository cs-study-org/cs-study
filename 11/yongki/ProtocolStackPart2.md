# 프로토콜 스택 ┃ Part 2

- [프로토콜 스택 ┃ Part 2](#프로토콜-스택--part-2)
  - [들어가며](#들어가며)
  - [데이터를 송·수신 한다.](#데이터를-송수신-한다)
    - [데이터 송신과 송신 버퍼](#데이터-송신과-송신-버퍼)
    - [데이터 송신과 패킷](#데이터-송신과-패킷)
    - [TCP 오류 검출과 회복](#tcp-오류-검출과-회복)
    - [패킷 최소화](#패킷-최소화)

## 들어가며

지난 주차에 이어 프로토콜 스택의 동작을 다음 주석부터 이어가자.

```
browser{
  DNS 송·수신 동작

  Socket.socket();  
  Socket.connect(); 
  Socket.write();     // +++ Start!
  Socket.read();
  Socket.close();
}
```

## 데이터를 송·수신 한다.

### 데이터 송신과 송신 버퍼

`Socket.write()`는 애플리케이션이 송신 데이터를 프로토콜 스택에 건네주는 것으로 시작한다.

프로토콜 스택은 애플리케이션으로 부터 받은 송신 데이터를 바로 송신하지 않고,

송신용 버퍼 메모리 영역에 저장한다.

이때, 애플리케이션이 송신 데이터를 한 번에 보낼지, 세분화해서 보낼지가 다르며

세분화한다면, 세분화된 데이터를 모두 송신용 버퍼에서 받기 위해 프로토콜 스택이 기다리기도 한다.

이 판단을 하는 요소는 2가지는 다음과 같다.

1. 한 패킷에 저장할 수 있는 데이터의 크기
2. 타이밍

> 사진 자료

### 데이터 송신과 패킷

송신 데이터를 한 번에 보낼 수 없을 정도로 데이터가 크다면,

분할시켜 분할한 데이터를 만든다. 즉, 패킷을 만든다.

분할된 패킷들은 각자의 TCP 헤더가 부가된다.

### TCP 오류 검출과 회복

TCP는 수신처가 올바르게 받았는지를 확인하는 기능이 있다.

[접속](https://slides.com/kimyongki/deck-2ebcd7/embed)의 과정부터 확인하기 전, 등장하는 단어의 역할을 짚어보자.

    시퀀스 번호:      중복된 패킷 검출
    SYN 컨트롤 비트:  수신측과 접속 성공 여부
    ACK 컨트롤 비트:  수신측으로의 올바른 도착 여부

1. 송신측은 송신측의 TCP 헤더를 만들고, 수신처의 포트 번호를 지정한다.
2. `송신측의 시퀀스 번호`와 `SYN 컨트롤 비트`를 1로 만든다.
3. 송신측은 요청 패킷을 보낸다.
4. 수신측은 요청 패킷을 받는데, 송신측의 시퀀스 번호를 통해 `중복된 패킷을 검출`한다.
5. 검출을 통과한 패킷을 받았다면, 수신측은 수신측의 TCP 헤더를 만든다.
6. `수신측의 시퀀스 번호`와 `SYN 컨트롤 비트`를 1로 만든다. 
7. 수신측은 또한, `ACK 번호를 송신측 시퀀스 번호 + 1`로 지정하고, `ACK 컨트롤 비트`를 1로 만든다. 
    > 이는 요청 패킷에 대한 확인을 나타낸다.
8. 수신측은 응답 패킷을 송신측에 보낸다.
9. 송신측은 응답 패킷을 받는데, `SYN 컨트롤 비트` 1로 수신측과 접속 성공을 확인한다.
10. 송신측은 또한 `ACK 번호가 자신(송신측)의 시퀀스 번호 + 1`인지 검출한다.
11. 접속 성공을 확인하면, 송신측 소켓에 수신측 제어 정보를 기록한다.
12. 검출을 통과한 패킷을 받았다면, 송신측은 송신측의 TCP 헤더를 다시 만든다. 
13. 송신측은 `ACK 번호를 수신측의 시퀀스 번호 + 1`로 지정하고, `ACK 컨트롤 비트`를 1로 만든다.    
    > 이는 응답 패킷에 대한 확인을 나타낸다.
14. 이렇게 응답 패킷에 대한 확인 패킷을 수신측에 보낸다.

### 패킷 최소화

[데이터](https://slides.com/kimyongki/week-11-connect/embed)를 송·수신하는 과정을 확인하기 전, 등장하는 단어의 역할을 짚어보자.

    윈도우:   수신측에서 송신측에 수신 받을 수 있는 양을 통지

1. 앞서 접속의 과정에서 수신측이 응답 패킷을 송신측에 보내는 과정에서 TCP 헤더에 `윈도우 필드가 추가`된다.
2. 송신측이 응답 패킷을 받을 때, 수신측의 수신용 버퍼를 고려하여 송신 가능 데이터를 추린다.
   > 이는 수신측이 윈도우 필드를 응답 패킷 마다 보낼 필요가 없는 이유이다.
3. 송신측으로부터 데이터 요청 패킷을 받은 수신측은 수신용 버퍼에 적재한다.
4. 만약 수신용 버퍼에 적재 도중 수신측 애플리케이션에 의해 버퍼가 일부 비워지면 어떻게 될까
5. 윈도우 필드가 추가된 패킷을 송신측에 또한번 알린다.
6. 이때, 데이터 응답 패킷에 합승하여 패킷의 수를 줄일 수 있다.
7. 데이터 응답 패킷 / 윈도우 통지 패킷 중 먼저 만들어진 쪽이 잠시 기다린다.

<hr/>

> a. 패킷 평균 왕복 시간으로 ACK 번호의 대기 시간을 조정한다.